name: 💻 Preflight Checks

on:
  workflow_dispatch:

jobs:
  preflight:
    name: ⚡ Preflight
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repo
        uses: actions/checkout@v4

      - name: 🐧 Install Preflight Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential wget curl ccache unzip tar cmake

      - name: 🔍 Verify Modules
        run: |
          # ModSecurity
          if [ "$ENABLE_MODSEC" = "true" ]; then
            if [ ! -d "./ModSecurity" ]; then
              echo "❌ ModSecurity repo missing"
              exit 1
            fi
          fi

          # Brotli
          if [ ! -d "./ngx_brotli/deps/brotli" ]; then
            echo "❌ Brotli submodule missing or not initialized"
            exit 1
          fi

          echo "✅ Soft preflight completed"
        env:
          ENABLE_MODSEC: true