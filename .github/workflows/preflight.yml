name: ğŸ›¡ï¸ NGINX-PARTY Preflight (âš¡ Validation + Dependencies)

on:
  workflow_dispatch:
  pull_request:

jobs:
  preflight:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Check system environment
        run: |
          echo "ğŸ–¥ï¸ OS Info:"
          uname -a
          echo "ğŸ’¾ Disk Usage:"
          df -h
          echo "ğŸ§° Installed Packages:"
          dpkg-query -l | grep -E "build-essential|git|wget|curl|gcc|g++|cmake|libssl"

      - name: ğŸŒ Verify dependencies for build
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git wget curl cmake \
            libpcre3 libpcre3-dev zlib1g zlib1g-dev \
            libssl-dev libxml2-dev libxslt1-dev libgd-dev \
            libgeoip-dev libjemalloc-dev libmaxminddb-dev \
            libtool autoconf automake pkg-config \
            libyajl-dev liblmdb-dev libcurl4-openssl-dev \
            python3 python3-pip libluajit-5.1-dev \
            libbrotli-dev libbrotli1 debhelper dh-make fakeroot
          echo "âœ… Dependencies installed"

      - name: ğŸ§ª Test NGINX source accessibility
        run: |
          git ls-remote https://github.com/nginx/nginx.git HEAD
          echo "âœ… NGINX repo reachable"

      - name: ğŸ”§ Validate ModSecurity module
        run: |
          git ls-remote https://github.com/SpiderLabs/ModSecurity.git HEAD
          echo "âœ… ModSecurity repo reachable"