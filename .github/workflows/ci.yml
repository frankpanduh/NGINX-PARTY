name: Build NGINX-PARTY .deb ğŸš€

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository ğŸ“¥
        uses: actions/checkout@v3

      - name: Install dependencies ğŸ”§
        run: |
          echo "âš¡ Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev wget git \
            debhelper dh-make checkinstall
          echo "âœ… Dependencies installed! ğŸ‰"

      - name: Clone NGINX ğŸŒ
        run: |
          echo "ğŸš Cloning NGINX mainline..."
          git clone https://github.com/nginx/nginx.git nginx || { echo "ğŸ’¥ğŸ› ERROR: Could not clone nginx!"; exit 1; }
          cd nginx
          git checkout master || { echo "ğŸ’¥ğŸ› ERROR: Could not checkout master branch!"; exit 1; }
          echo "âœ… NGINX cloned successfully! ğŸš€"

      - name: Clone QUIC module âš¡
        run: |
          echo "ğŸš Cloning Cloudflare quiche..."
          git clone --recursive -b main https://github.com/cloudflare/quiche.git ../nginx-quic || { echo "ğŸ’¥ğŸ› ERROR: Could not clone quiche!"; exit 1; }
          echo "âœ… QUIC module cloned successfully! ğŸŒˆ"

      - name: Configure & Build NGINX ğŸ”¨
        run: |
          cd nginx
          wget https://www.openssl.org/source/openssl-3.1.4.tar.gz || { echo "ğŸ’¥ğŸ› OpenSSL download failed!"; exit 1; }
          tar xzf openssl-3.1.4.tar.gz || { echo "ğŸ’¥ğŸ› OpenSSL extract failed!"; exit 1; }

          ./auto/configure \
            --with-http_ssl_module \
            --with-http_v3_module \
            --with-openssl=./openssl-3.1.4 \
            --add-module=../nginx-quic \
            --with-stream \
            --with-cc-opt='-O2 -g' \
            --with-ld-opt='-Wl,-rpath,/usr/local/lib' || { echo "ğŸ’¥ğŸ› Configure failed!"; exit 1; }

          echo "âš¡ Starting make..."
          if make -j$(nproc); then
            echo "ğŸ‰ Build successful! ğŸŒŸ"
          else
            echo "ğŸ’¥ğŸ› Build failed! Check logs carefully. âš ï¸" >&2
            exit 1
          fi

      - name: Create .deb package ğŸ“¦
        run: |
          cd nginx
          echo "âš¡ Creating .deb package..."
          checkinstall --install=no --pkgname=nginx-party --pkgversion=1.0 \
            --backup=no --fstrans=no --default make install || { echo "ğŸ’¥ğŸ› .deb packaging failed!"; exit 1; }
          echo "âœ… .deb package ready! ğŸ‰"

      - name: Upload .deb artifact ğŸš€
        uses: actions/upload-artifact@v4
        with:
          name: nginx-party-deb
          path: ./nginx/nginx-party_1.0-1_amd64.deb
          retention-days: 7
