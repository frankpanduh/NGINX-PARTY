name: ğŸ¼ğŸš€ NGINX PARTY - Cyberpunk Panda CI ğŸŒŒğŸ’¾

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ENABLE_MODSEC: true
      MODSEC_MODE: DetectionOnly
      NGINX_VERSION: latest
      OPENSSL_VERSION: 3.3.1

    steps:
      - name: ğŸ›°ï¸ Checkout source
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ¼âœ¨ System prep
        run: |
          echo "ğŸŒŒ [CyberPanda] Updating system packages..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential automake autoconf libtool git cmake \
            libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev \
            libxml2 libxml2-dev libyajl-dev pkg-config \
            libgeoip-dev libcurl4-openssl-dev liblmdb-dev \
            doxygen

      - name: ğŸ” Build OpenSSL
        run: |
          echo "ğŸš€ [CyberPanda] Building OpenSSL v${OPENSSL_VERSION}..."
          curl -sL https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz | tar xz
          cd openssl-${OPENSSL_VERSION}
          ./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl shared zlib
          make -j$(nproc)
          sudo make install
          cd ..
          echo "ğŸ’¾ OpenSSL installed @ /usr/local/openssl"

      - name: ğŸ¼âš”ï¸ Build ModSecurity
        run: |
          echo "ğŸŒŒ [CyberPanda] Initializing ModSecurity modules..."
          git clone --depth 1 --recursive https://github.com/SpiderLabs/ModSecurity
          cd ModSecurity
          git submodule update --init --recursive
          autoreconf -fi
          ./configure
          make -j$(nproc)
          sudo make install
          cd ..
          echo "âœ… [CyberPanda] ModSecurity built and installed!"

      - name: ğŸ“¦ Fetch NGINX + Modules
        run: |
          echo "ğŸš€ [CyberPanda] Fetching NGINX v${NGINX_VERSION} & modules..."
          git clone https://github.com/nginx/nginx.git --depth 1 --branch ${NGINX_VERSION}
          git clone https://github.com/google/ngx_brotli.git
          cd ngx_brotli && git submodule update --init --recursive && cd ..
          git clone https://github.com/aperezdc/ngx-fancyindex.git
          git clone https://github.com/SpiderLabs/ModSecurity-nginx.git

      - name: ğŸ› ï¸ Build NGINX
        run: |
          echo "ğŸŒŒ [CyberPanda] Building NGINX with all the toys..."
          cd nginx
          ./auto/configure \
            --with-compat \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --add-module=../ngx_brotli \
            --add-module=../ngx-fancyindex \
            --add-module=../ModSecurity-nginx \
            --with-openssl=../openssl-${OPENSSL_VERSION} \
            --prefix=/etc/nginx
          make -j$(nproc)
          sudo make install
          cd ..
          echo "ğŸ¼ğŸš€ [CyberPanda] NGINX PARTY successfully built!"

      - name: ğŸ‰ Final message
        run: echo "ğŸ¼ğŸŒŒğŸš€ NGINX PARTY build complete â€” welcome to the Cyberpunk Panda Space rave ğŸ’¾âš¡"
