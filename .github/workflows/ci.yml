name: Build NGINX-PARTY .deb 🚀

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository 📥
        uses: actions/checkout@v3

      # Step 2: Install build dependencies
      - name: Install dependencies 🔧
        run: |
          echo "⚡ Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev wget git
          echo "✅ Dependencies installed!"

      # Step 3: Clone official NGINX
      - name: Clone NGINX 🌐
        run: |
          echo "🐚 Cloning NGINX mainline..."
          git clone https://github.com/nginx/nginx.git || { echo "🐛 ERROR: Could not clone nginx!"; exit 1; }
          cd nginx
          git checkout main || { echo "🐛 ERROR: Could not checkout main branch!"; exit 1; }
          echo "✅ NGINX cloned successfully!"

      # Step 4: Configure & Build NGINX
      - name: Configure & Build NGINX ⚡
        run: |
          echo "🔨 Configuring build..."
          cd nginx
          wget https://www.openssl.org/source/openssl-3.1.4.tar.gz || { echo "🐛 ERROR: OpenSSL download failed!"; exit 1; }
          tar xzf openssl-3.1.4.tar.gz || { echo "🐛 ERROR: OpenSSL extract failed!"; exit 1; }

          ./auto/configure \
            --with-http_ssl_module \
            --with-http_v3_module \
            --with-openssl=./openssl-3.1.4 \
            --with-stream \
            --with-cc-opt='-O2 -g' \
            --with-ld-opt='-Wl,-rpath,/usr/local/lib' || { echo "🐛 ERROR: Configure failed!"; exit 1; }

          echo "⚡ Starting make..."
          if make -j$(nproc); then
            echo "🎉 Build successful!"
          else
            echo "💥🐛 Build failed! Check logs carefully." >&2
            exit 1
          fi

      # Step 5: Upload artifact
      - name: Upload .deb artifact 📦
        uses: actions/upload-artifact@v4
        with:
          name: nginx-party-deb
          path: ./nginx # Adjust to actual .deb output
          retention-days: 7
