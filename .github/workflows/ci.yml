name: Build NGINX-PARTY .deb 🚀

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository 📥
        uses: actions/checkout@v3

      - name: Install build dependencies 🔧
        run: |
          echo "⚡ Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libpcre3 libpcre3-dev zlib1g zlib1g-dev libssl-dev wget git \
            debhelper dh-make checkinstall pkg-config \
            libjpeg-dev libpng-dev libwebp-dev libavif-dev
          echo "✅ Dependencies installed! 🎉"

      - name: Clone Cloudflare nginx-quiche 🌐
        run: |
          echo "🐚 Cloning Cloudflare nginx-quiche..."
          git clone --recursive https://github.com/cloudflare/nginx-quiche.git nginx || { echo "💥🐛 ERROR: Could not clone nginx-quiche!"; exit 1; }
          cd nginx
          git checkout master
          echo "✅ Cloudflare NGINX-QUIC cloned successfully! 🌈"

      - name: Configure & Build NGINX 🔨
        run: |
          cd nginx
          wget https://www.openssl.org/source/openssl-3.1.4.tar.gz || { echo "💥🐛 OpenSSL download failed!"; exit 1; }
          tar xzf openssl-3.1.4.tar.gz || { echo "💥🐛 OpenSSL extract failed!"; exit 1; }

          ./auto/configure \
            --with-http_ssl_module \
            --with-http_v3_module \
            --with-http_v2_module \
            --with-stream \
            --with-http_realip_module \
            --with-http_secure_link_module \
            --with-http_stub_status_module \
            --with-cc-opt='-O2 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2 -fPIE' \
            --with-ld-opt='-Wl,-z,relro,-z,now -pie -Wl,-rpath,/usr/local/lib' \
            --with-openssl=./openssl-3.1.4 || { echo "💥🐛 Configure failed!"; exit 1; }

          echo "⚡ Starting make..."
