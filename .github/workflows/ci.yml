name: Build NGINX-PARTY .deb üöÄ

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NGINX_VERSION: 1.27.3
      OPENSSL_VERSION: 3.3.1
      ENABLE_MODSEC: true
      MODSEC_MODE: DetectionOnly

    steps:
      - name: Checkout repo üì•
        uses: actions/checkout@v3

      - name: Install build dependencies üõ†Ô∏è
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libpcre3-dev zlib1g-dev libssl-dev \
            git cmake automake libtool pkg-config \
            libmaxminddb-dev wget curl libxml2-dev libyajl-dev \
            python3 python3-pip rustc cargo \
            libbrotli-dev libzstd-dev libgeoip-dev libcurl4-openssl-dev \
            libpcre2-dev curl unzip

      - name: Clone NGINX and modules üåê
        run: |
          git clone https://github.com/nginx/nginx.git
          git clone --depth 1 https://github.com/google/ngx_brotli.git
          git clone --depth 1 https://github.com/tokers/zstd-nginx-module.git
          git clone --depth 1 https://github.com/leev/ngx_http_geoip2_module.git
          git clone --depth 1 https://github.com/openresty/headers-more-nginx-module.git
          git clone --depth 1 https://github.com/FRiCKLE/ngx_cache_purge.git
          git clone --depth 1 https://github.com/aperezdc/ngx-fancyindex.git
          git clone --depth 1 https://github.com/SpiderLabs/ModSecurity.git
          git clone --depth 1 https://github.com/SpiderLabs/ModSecurity-nginx.git

      - name: Build ModSecurity üîí
        run: |
          cd ModSecurity
          git submodule init
          git submodule update
          ./build.sh
          ./configure
          make
          sudo make install
          cd ..

      - name: Configure and build NGINX ‚ö°
        run: |
          cd nginx
          ./auto/configure \
            --with-compat \
            --with-stream \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_v3_module \
            --add-dynamic-module=../ngx_brotli \
            --add-dynamic-module=../zstd-nginx-module \
            --add-dynamic-module=../ngx_http_geoip2_module \
            --add-dynamic-module=../headers-more-nginx-module \
            --add-dynamic-module=../ngx_cache_purge \
            --add-dynamic-module=../ngx-fancyindex \
            --with-ld-opt="-Wl,-rpath,/usr/local/modsecurity/lib -L/usr/local/modsecurity/lib"
          make
          sudo make install
          cd ..

      - name: Package .deb üì¶
        run: |
          mkdir -p deb
          fpm -s dir -t deb -n nginx-party -v $NGINX_VERSION \
            --prefix=/usr/local/nginx \
            --after-install=extras/postinstall.sh \
            ./nginx/

      - name: Upload .deb artifact üöÄ
        uses: actions/upload-artifact@v3
        with:
          name: nginx-party-deb
          path: ./deb/nginx-party*.deb
