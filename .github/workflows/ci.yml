name: Build NGINX-PARTY .deb 🚀

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:

      # Step 1: Checkout repo
      - name: Checkout repository 📥
        uses: actions/checkout@v3

      # Step 2: Setup SSH key for quiche fallback
      - name: Setup SSH key 🔑
        run: |
          if [ -n "${{ secrets.QUIC_DEPLOY_KEY }}" ]; then
            mkdir -p ~/.ssh
            echo "${{ secrets.QUIC_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            echo "✅ SSH key configured"
          else
            echo "⚠️ QUIC_DEPLOY_KEY secret not set — skipping SSH setup"
          fi

      # Step 3: Clone nginx-quiche
      - name: Clone Cloudflare nginx-quiche 🌐
        run: |
          echo "🐚 Cloning nginx-quiche..."
          set -e
          if git clone https://github.com/cloudflare/nginx-quiche.git nginx-quiche; then
              echo "✅ Cloned via HTTPS"
          else
              echo "⚡ HTTPS failed, trying SSH..."
              git clone git@github.com:cloudflare/nginx-quiche.git nginx-quiche || { echo "💥🐛 ERROR: Could not clone quiche via SSH!"; exit 1; }
          fi

      # Step 4: Install build dependencies
      - name: Install dependencies 🔧
        run: |
          echo "⚡ Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential libpcre3 libpcre3-dev \
            zlib1g zlib1g-dev libssl-dev wget git libgeoip-dev libmaxminddb0 \
            ca-certificates curl unzip checkinstall
          echo "✅ Dependencies installed!"

      # Step 5: Download OpenSSL
      - name: Download OpenSSL 🛡
        run: |
          wget https://www.openssl.org/source/openssl-3.1.4.tar
