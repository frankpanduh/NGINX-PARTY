name: Build NGINX üêº with modules ‚õΩ

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repo
      - name: Checkout repository üì¶
        uses: actions/checkout@v4

      # 2) Install build dependencies
      - name: Install dependencies üõ†
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libpcre3 \
            libpcre3-dev \
            zlib1g \
            zlib1g-dev \
            libssl-dev \
            libmaxminddb-dev \
            git \
            cmake \
            automake \
            autoconf \
            libtool \
            pkg-config

      # 3) Download NGINX source
      - name: Download NGINX source üåê
        run: |
          curl -O http://nginx.org/download/nginx-1.27.1.tar.gz
          tar -xzvf nginx-1.27.1.tar.gz
          mv nginx-1.27.1 nginx

      # 4) Clone third-party modules
      - name: Clone third-party modules üß©
        run: |
          # Brotli
          git clone --depth 1 https://github.com/google/ngx_brotli.git
          (cd ngx_brotli && git submodule update --init --recursive)
          (cd ngx_brotli/deps/brotli && make -j"$(nproc)")

          # Zstandard
          git clone --depth 1 https://github.com/tokers/zstd-nginx-module.git

          # GeoIP2
          git clone --depth 1 https://github.com/leev/ngx_http_geoip2_module.git

          # Headers More
          git clone --depth 1 https://github.com/openresty/headers-more-nginx-module.git

          # Cache purge
          git clone --depth 1 https://github.com/FRiCKLE/ngx_cache_purge.git

          # Fancy index
          git clone --depth 1 https://github.com/aperezdc/ngx-fancyindex.git

          echo "‚úÖ Third-party modules ready"

      # 5) Configure NGINX
      - name: Configure NGINX ‚öôÔ∏è
        run: |
          cd nginx
          ./configure \
            --prefix=/etc/nginx \
            --sbin-path=/usr/sbin/nginx \
            --conf-path=/etc/nginx/nginx.conf \
            --error-log-path=/var/log/nginx/error.log \
            --http-log-path=/var/log/nginx/access.log \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --add-module=../ngx_brotli \
            --add-module=../zstd-nginx-module \
            --add-module=../ngx_http_geoip2_module \
            --add-module=../headers-more-nginx-module \
            --add-module=../ngx_cache_purge \
            --add-module=../ngx-fancyindex

      # 6) Build & Install
      - name: Build and Install NGINX üèó
        run: |
          cd nginx
          make -j"$(nproc)"
          sudo make install
          nginx -V

      # 7) Upload artifact
      - name: Upload NGINX binary üì§
        uses: actions/upload-artifact@v4
        with:
          name: nginx-custom
          path: /usr/sbin/nginx
