name: üõ†Ô∏è PANDUH-PARTY CI (Stable + QUIC + Mods)

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  NGINX_VERSION: release-1.29.1
  OPENSSL_VERSION: 3.3.1
  ENABLE_MODSEC: true
  MODSEC_MODE: DetectionOnly

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: üíæ Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ env.NGINX_VERSION }}

      - name: üåê Clone NGINX Source
        run: |
          echo "Fetching NGINX ${NGINX_VERSION} source..."
          git clone --branch ${NGINX_VERSION} --depth 1 https://github.com/nginx/nginx.git nginx-${NGINX_VERSION}-src
          cd nginx-${NGINX_VERSION}-src
          if [ ! -f "./auto/configure" ]; then
            echo "‚ùå nginx/auto/configure missing!"
            exit 1
          fi
          cd ..

      - name: üì¶ Build NGINX + Modules
        run: |
          cd nginx-${NGINX_VERSION}-src
          ./auto/configure \
            --with-compat \
            --with-http_ssl_module \
            --with-http_v3_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-threads \
            --with-http_gzip_static_module \
            --with-http_v2_module \
            --with-http_image_filter_module \
            --with-http_websocket_module \
            --with-http_videostream_module \
            --add-module=../ngx_brotli \
            --add-module=../ngx_cache_purge \
            --add-module=../ngx-fancyindex \
            $( [ "$ENABLE_MODSEC" == "true" ] && echo "--add-module=../ModSecurity/nginx/modsecurity" )
          make -j$(nproc)
          sudo make install
          cd ..
          echo "üöÄ NGINX + ModSecurity build complete ‚Äî panda style!"

      - name: üì¶ Build DEB Package
        run: |
          cd nginx-${NGINX_VERSION}-src
          sudo checkinstall --pkgname=nginx-party --pkgversion=1.29.1 --backup=no --deldoc=yes --fstrans=no --default
          cd ..
          echo "‚úÖ DEB package ready!"